name: Build & Publish Template

on:
  push:
    branches: [main, master]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: false

env:
  # Repository name (e.g., "default1", "minimal", "shadcn")
  # Worker will be named: storefront-template-{TEMPLATE_NAME}
  TEMPLATE_NAME: ${{ github.event.repository.name }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Normalize template name
        id: template
        run: |
          # Strip "storefront-" prefix if present
          RAW_NAME="${{ env.TEMPLATE_NAME }}"
          NORMALIZED="${RAW_NAME#storefront-}"
          echo "name=${NORMALIZED}" >> $GITHUB_OUTPUT
          echo "Template name: ${NORMALIZED}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build for Cloudflare (OpenNext)
        run: npx @opennextjs/cloudflare build

      - name: List build output
        run: |
          echo "=== Build output ==="
          ls -la .open-next/ || echo "No .open-next directory"
          if [ -f ".open-next/worker.js" ]; then
            echo "Worker size: $(wc -c < .open-next/worker.js) bytes"
          fi

      - name: Create deployment wrangler.toml
        run: |
          cat > .open-next/wrangler.toml << EOF
          name = "storefront-template-${{ steps.template.outputs.name }}"
          main = "worker.js"
          compatibility_date = "2024-09-23"
          compatibility_flags = ["nodejs_compat"]
          assets = { directory = "assets", binding = "ASSETS" }
          EOF

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(jq -r .version package.json)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Cloudflare Workers
        working-directory: .open-next
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "⏭️ Skipping CF deploy (CLOUDFLARE_API_TOKEN not set)"
            exit 0
          fi
          npx wrangler deploy

      - name: Upload worker bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: worker-bundle
          path: .open-next/
          retention-days: 7
          if-no-files-found: error
          include-hidden-files: true

      - name: Publish to DoSwiftly (on tag or manual)
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        env:
          DOSWIFTLY_TOKEN: ${{ secrets.DOSWIFTLY_DEPLOY_TOKEN }}
          DOSWIFTLY_API_URL: ${{ secrets.DOSWIFTLY_API_URL }}
        run: |
          # Upload bundle to DoSwiftly R2 via API
          curl -X POST "${DOSWIFTLY_API_URL}/cli/templates/${{ steps.template.outputs.name }}/publish" \
            -H "Authorization: Bearer ${DOSWIFTLY_TOKEN}" \
            -F "bundle=@.open-next/worker.js" \
            -F "version=${{ steps.version.outputs.version }}"
